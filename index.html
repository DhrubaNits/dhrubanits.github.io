<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Running Group — Attendance</title>
  <style>
    :root { --accent: #0b74de; }
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background: #f6fbff; padding: 16px; }
    .container{ max-width:820px;margin:0 auto; }
    .card{ background:white;border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(12,20,40,0.06); margin-bottom:16px; }
    input,button{ width:100%; padding:10px; margin-top:8px; border-radius:10px; border:1px solid #e6eef8; }
    button{ background:var(--accent); color:white; font-weight:600; border:0; cursor:pointer; }
    .btn-ghost{ background:transparent; color:var(--accent); border:1px solid #e1efff; }
    .row{ display:flex; gap:8px; }
    .col{ flex:1; }
    .small{ font-size:13px; color:#556; }
    .list{ max-height:260px; overflow:auto; margin-top:8px; }
    .item{ padding:10px; border-radius:8px; border:1px solid #eef6ff; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
    @media(max-width:600px){ .row{ flex-direction:column; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>Submit Attendance</h2>
      <p class="small">Admin must open submissions for today before you can submit.</p>
      <label>Your name</label>
      <input id="name" type="text" placeholder="Enter your full name" />
      <button id="submitBtn" onclick="submitAtt()">Submit Attendance</button>
      <p id="msg" class="small"></p>
    </div>

    <div class="card">
      <h2>Admin Panel</h2>
      <label>Admin password</label>
      <input id="adminPass" type="password" placeholder="Admin password" />
      <div class="row" style="margin-top:8px;">
        <div class="col"><button onclick="toggleDay(true)">Open Today</button></div>
        <div class="col"><button class="btn-ghost" onclick="toggleDay(false)">Close Today</button></div>
      </div>
      <p id="adminMsg" class="small"></p>
      <hr />
      <h3 class="small">Pending submissions</h3>
      <div id="pendingList" class="list"></div>
    </div>

    <div class="card">
      <h2>Today's Attendance</h2>
      <div id="history" class="list"></div>
    </div>
  </div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbza0bJadllK-u9U0S4uvfkqzThF83viehIV3Os5q714xAVIwjj_ELySiPGFYcMdVOM3/exec'; // <-- REPLACE THIS with deployed Apps Script Web App URL

    async function api(payload) {
      try {
        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        return await res.json();
      } catch (e) {
        console.error(e);
        return { success:false, error: e.toString() };
      }
    }

    function today() { return new Date().toISOString().slice(0,10); }

    async function submitAtt() {
      const name = document.getElementById('name').value.trim();
      if (!name) { document.getElementById('msg').innerText = 'Please enter your name.'; return; }
      const r = await api({ action:'submitAttendance', name: name, date: today() });
      document.getElementById('msg').innerText = r.success ? 'Submitted — awaiting approval' : ('Error: ' + (r.error || 'Unknown'));
      loadPending(); loadHistory();
    }

    async function loadPending() {
      const r = await api({ action:'getPending' });
      const cont = document.getElementById('pendingList'); cont.innerHTML = '';
      if (r && r.pending) {
        r.pending.forEach(p => {
          const el = document.createElement('div'); el.className = 'item';
          const left = document.createElement('div');
          left.innerHTML = `<strong>${escapeHtml(p.name)}</strong><div class="small">${p.date} · ${p.timestamp ? new Date(p.timestamp).toLocaleTimeString() : ''}</div>`;
          const btn = document.createElement('button'); btn.className = 'btn-ghost'; btn.innerText = 'Approve';
          btn.onclick = () => approveRow(p.row);
          el.appendChild(left);
          el.appendChild(btn);
          cont.appendChild(el);
        });
      } else {
        cont.innerHTML = '<div class="small">No pending submissions</div>';
      }
    }

    async function loadHistory() {
      const r = await api({ action:'getAll', date: today() });
      const cont = document.getElementById('history'); cont.innerHTML = '';
      if (r && r.rows && r.rows.length) {
        r.rows.forEach(row => {
          const el = document.createElement('div'); el.className = 'item';
          el.innerHTML = `<div><strong>${escapeHtml(row.name)}</strong><div class="small">${row.status}${row.approvedBy?(' · by '+escapeHtml(row.approvedBy)):''}</div></div>`;
          cont.appendChild(el);
        });
      } else {
        cont.innerHTML = '<div class="small">No attendance recorded for today</div>';
      }
    }

    async function approveRow(row) {
      const adminPass = document.getElementById('adminPass').value;
      if (!adminPass) { document.getElementById('adminMsg').innerText = 'Enter admin password'; return; }
      const r = await api({ action:'approveEntry', row: row, adminPass: adminPass });
      document.getElementById('adminMsg').innerText = r.success ? 'Approved' : ('Error: ' + (r.error || ''));
      loadPending(); loadHistory();
    }

    async function toggleDay(open) {
      const adminPass = document.getElementById('adminPass').value;
      if (!adminPass) { document.getElementById('adminMsg').innerText = 'Enter admin password'; return; }
      const r = await api({ action:'toggleDay', date: today(), open: open, adminPass: adminPass });
      document.getElementById('adminMsg').innerText = r.success ? ('Day ' + (open ? 'opened' : 'closed')) : ('Error: ' + (r.error || ''));
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // initial load
    loadPending(); loadHistory();
  </script>
</body>
</html>





