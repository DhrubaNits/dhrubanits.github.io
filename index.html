<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Running Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --bg-card-elevated: #020617;
      --border: #1e293b;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --accent-hover: #2563eb;
      --danger: #ef4444;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --radius-lg: 18px;
      --radius-sm: 10px;
      --shadow-soft: 0 16px 40px rgba(15, 23, 42, 0.7);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .app-shell {
      width: 100%;
      max-width: 1120px;
      border-radius: 32px;
      border: 1px solid #1e293b;
      background: radial-gradient(circle at 0 0, rgba(59,130,246,0.18), transparent 45%),
                  radial-gradient(circle at 100% 0, rgba(236,72,153,0.18), transparent 45%),
                  #020617;
      box-shadow: var(--shadow-soft);
      padding: 24px 24px 20px;
      position: relative;
      overflow: hidden;
    }

    .app-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(148,163,184,0.08), transparent 60%);
      pointer-events: none;
    }

    .app-inner {
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      margin: 0;
      font-size: 1.5rem;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.logo-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: radial-gradient(circle, #34d399, #22c55e);
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }

    .subtitle {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .today-pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 0.8rem;
      color: #cbd5f5;
      background: radial-gradient(circle at top, rgba(79,70,229,0.5), transparent 50%);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .today-pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 4px rgba(34,197,94,0.9);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 18px;
    }

    @media (max-width: 840px) {
      .app-shell {
        padding: 18px 16px 14px;
        border-radius: 0;
      }
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      border-radius: 24px;
      padding: 16px 16px 18px;
      border: 1px solid rgba(30,64,175,0.7);
      background:
        linear-gradient(145deg, rgba(15,23,42,0.8), rgba(15,23,42,0.95)),
        radial-gradient(circle at top, rgba(37,99,235,0.3), transparent 55%);
      backdrop-filter: blur(18px);
    }

    .card--admin {
      border-color: rgba(236,72,153,0.8);
      background:
        linear-gradient(145deg, rgba(15,23,42,0.92), rgba(15,23,42,0.98)),
        radial-gradient(circle at top right, rgba(236,72,153,0.35), transparent 55%);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .card h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .badge {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--muted);
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    input, select {
      width: 100%;
      padding: 9px 11px;
      font-size: 0.9rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.86);
      color: var(--text);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.5);
      background: rgba(15,23,42,1);
    }

    button {
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), #6366f1);
      color: white;
      font-size: 0.87rem;
      padding: 8px 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease;
      box-shadow: 0 12px 24px rgba(37,99,235,0.45);
      white-space: nowrap;
    }

    button:hover {
      background: linear-gradient(135deg, var(--accent-hover), #4f46e5);
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(37,99,235,0.6);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 8px 20px rgba(37,99,235,0.5);
    }

    button.btn-ghost {
      background: transparent;
      box-shadow: none;
      border: 1px solid rgba(148,163,184,0.6);
      color: var(--muted);
      padding-inline: 10px;
      font-size: 0.8rem;
    }

    button.btn-ghost:hover {
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
    }

    button.btn-danger {
      background: linear-gradient(135deg, #ef4444, #f97316);
      box-shadow: 0 12px 24px rgba(248,113,113,0.5);
    }

    button.btn-sm {
      padding: 6px 10px;
      font-size: 0.8rem;
      border-radius: 999px;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 14px;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .row > * {
      flex: 1 1 auto;
      min-width: 0;
    }

    .message {
      font-size: 0.78rem;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      min-height: 22px;
      display: flex;
      align-items: center;
    }

    .message--error {
      color: #fecaca;
      border-color: rgba(248,113,113,0.5);
      background: linear-gradient(135deg, rgba(127,29,29,0.9), rgba(15,23,42,0.95));
    }

    .message--success {
      color: #bbf7d0;
      border-color: rgba(34,197,94,0.5);
      background: linear-gradient(135deg, rgba(22,101,52,0.9), rgba(15,23,42,0.95));
    }

    .list-section-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .list-scroll {
      max-height: 180px;
      overflow: auto;
      border-radius: 14px;
      border: 1px solid rgba(30,64,175,0.6);
      background: radial-gradient(circle at top left, rgba(15,23,42,1), rgba(15,23,42,0.98));
      padding: 6px 6px 4px;
    }

    .list-scroll.empty {
      border-style: dashed;
      border-color: rgba(148,163,184,0.5);
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.78rem;
      padding: 10px;
    }

    .pending-item {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.1fr) auto;
      gap: 6px;
      align-items: center;
      padding: 6px 8px;
      border-radius: 12px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(51,65,85,0.9);
      margin-bottom: 6px;
      font-size: 0.8rem;
    }

    .pending-name {
      font-weight: 500;
      color: #e5e7eb;
    }

    .pending-date {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .pending-actions {
      display: flex;
      gap: 4px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .table {
      width: 100%;
      border-spacing: 0;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    .table th,
    .table td {
      padding: 6px 4px;
      text-align: left;
    }

    .table th {
      font-weight: 500;
      color: var(--muted);
      border-bottom: 1px solid rgba(51,65,85,0.9);
      position: sticky;
      top: 0;
      background: rgba(15,23,42,0.98);
    }

    .table tr:nth-child(even) td {
      background: rgba(15,23,42,0.85);
    }

    .table tr td {
      border-bottom: 1px solid rgba(30,41,59,0.7);
    }

    .pill {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 0.72rem;
      border: 1px solid rgba(148,163,184,0.5);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill--present {
      border-color: rgba(34,197,94,0.7);
      color: #bbf7d0;
    }

    .pill--el {
      border-color: rgba(234,179,8,0.7);
      color: #fef08a;
    }

    .pill--pending {
      border-color: rgba(59,130,246,0.7);
      color: #bfdbfe;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .history-small {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      font-size: 0.72rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--muted);
      background: rgba(15,23,42,0.9);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="app-inner">
      <header>
        <div class="title-block">
          <h1><span class="logo-dot"></span> Running Attendance</h1>
          <p class="subtitle">Registered names only · Admin approval · EL friendly · Live percentages</p>
        </div>
        <div class="today-pill" id="today-pill">
          <span class="today-pill-dot"></span>
          <span>Today: <strong id="today-label"></strong></span>
        </div>
      </header>

      <main>
        <!-- Student Panel -->
        <section class="card">
          <div class="card-header">
            <h2>Student</h2>
            <span class="badge">Registered users only</span>
          </div>

          <div class="stack">
            <div>
              <label for="student-name">Your registered name</label>
              <input id="student-name" type="text" placeholder="e.g. John Doe" autocomplete="off" />
            </div>
            <div class="row">
              <button id="btn-submit-att">Submit Attendance</button>
              <button class="btn-ghost" id="btn-my-percent">View My %</button>
            </div>
            <div id="student-msg" class="message"></div>
          </div>

          <div class="stack" style="margin-top:10px;">
            <div class="list-section-title">
              <span>My Attendance Summary</span>
              <span class="history-small" id="student-summary-name"></span>
            </div>
            <div class="chips-row" id="student-summary-chips">
              <!-- Filled by JS -->
            </div>
          </div>

          <div class="stack" style="margin-top:12px;">
            <div class="history-header">
              <span class="list-section-title" style="margin:0;">Today's Attendance Snapshot</span>
              <button class="btn-ghost btn-sm" id="btn-refresh-history">Refresh</button>
            </div>
            <div class="list-scroll" id="history-list">
              <!-- Filled by JS -->
            </div>
          </div>
        </section>

        <!-- Admin Panel -->
        <section class="card card--admin">
          <div class="card-header">
            <h2>Admin Console</h2>
            <span class="badge">Protected by password</span>
          </div>

          <div class="stack">
            <div class="row">
              <div>
                <label for="admin-password">Admin password</label>
                <input id="admin-password" type="password" placeholder="••••••••" />
              </div>
              <div style="display:flex; align-items:flex-end; justify-content:flex-end;">
                <button class="btn-ghost btn-sm" id="btn-clear-admin">Clear</button>
              </div>
            </div>
            <div id="admin-msg" class="message"></div>
          </div>

          <!-- Day Controls + Member Registration -->
          <div class="stack" style="margin-top:8px;">
            <div class="row">
              <div>
                <div class="list-section-title">
                  <span>Day Control</span>
                  <span class="history-small">Affects all students</span>
                </div>
                <div class="row">
                  <button class="btn-sm" id="btn-open-today">Open Today</button>
                  <button class="btn-sm btn-danger" id="btn-close-today">Close Today</button>
                </div>
              </div>
              <div>
                <div class="list-section-title">
                  <span>Register Member</span>
                  <span class="history-small">Active members only</span>
                </div>
                <div class="row">
                  <input id="register-name" type="text" placeholder="New member name" />
                  <button class="btn-sm" id="btn-register">Add</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Pending Submissions -->
          <div class="stack" style="margin-top:10px;">
            <div class="list-section-title">
              <span>Pending Submissions</span>
              <button class="btn-ghost btn-sm" id="btn-refresh-pending">Refresh</button>
            </div>
            <div id="pending-list" class="list-scroll empty">
              No pending submissions.
            </div>
          </div>

          <!-- Members + Percentages -->
          <div class="stack" style="margin-top:10px;">
            <div class="row">
              <div>
                <div class="list-section-title">
                  <span>Registered Members</span>
                  <button class="btn-ghost btn-sm" id="btn-refresh-members">Refresh</button>
                </div>
                <div id="members-list" class="list-scroll empty">
                  No members yet.
                </div>
              </div>
              <div>
                <div class="list-section-title">
                  <span>Attendance % (All)</span>
                  <button class="btn-ghost btn-sm" id="btn-refresh-percent-all">Refresh</button>
                </div>
                <div id="percent-all" class="list-scroll empty">
                  No data yet.
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const WEB_APP_URL = "https://attandance-proxy.dhrubajyotikalita094.workers.dev/";

    // ===== UTILITIES =====
    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }

    function formatDateHuman(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return d.toLocaleDateString(undefined, {
        weekday: "short",
        year: "numeric",
        month: "short",
        day: "numeric"
      });
    }

    function setMessage(el, msg, type = "") {
      el.textContent = msg || "";
      el.classList.remove("message--error", "message--success");
      if (type === "error") el.classList.add("message--error");
      else if (type === "success") el.classList.add("message--success");
    }

    async function api(payload) {
      try {
        const res = await fetch(WEB_APP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        return await res.json();
      } catch (e) {
        console.error(e);
        return { success: false, error: e.message || String(e) };
      }
    }

    function getAdminPassword() {
      return document.getElementById("admin-password").value.trim();
    }

    // ===== STUDENT FUNCTIONS =====
    async function submitAttendance() {
      const nameInput = document.getElementById("student-name");
      const msgEl = document.getElementById("student-msg");
      const name = nameInput.value.trim();

      if (!name) {
        setMessage(msgEl, "Please enter your registered name.", "error");
        return;
      }

      setMessage(msgEl, "Submitting…");

      const res = await api({
        action: "submitAttendance",
        name,
        date: todayISO(),
      });

      if (res.success) {
        setMessage(msgEl, "Attendance submitted and awaiting approval.", "success");
        loadTodayHistory();
      } else {
        setMessage(msgEl, res.error || "Failed to submit.", "error");
      }
    }

    async function loadMyPercentage() {
      const nameInput = document.getElementById("student-name");
      const msgEl = document.getElementById("student-msg");
      const chipsEl = document.getElementById("student-summary-chips");
      const labelEl = document.getElementById("student-summary-name");
      const name = nameInput.value.trim();

      if (!name) {
        setMessage(msgEl, "Enter your registered name to view percentage.", "error");
        return;
      }

      setMessage(msgEl, "Loading your percentage…");

      const res = await api({
        action: "getPercentForName",
        name,
      });

      if (!res.success) {
        setMessage(msgEl, res.error || "Failed to load percentage.", "error");
        chipsEl.innerHTML = "";
        labelEl.textContent = "";
        return;
      }

      const s = res.stats || {};
      setMessage(msgEl, "Loaded latest stats.", "success");
      labelEl.textContent = name;

      chipsEl.innerHTML = `
        <div class="chip">Working days: <strong>${s.totalWorkingDays || 0}</strong></div>
        <div class="chip">Present: <strong>${s.present || 0}</strong></div>
        <div class="chip">EL: <strong>${s.el || 0}</strong></div>
        <div class="chip">Counted attended: <strong>${s.attended || 0}</strong></div>
        <div class="chip">Percentage: <strong>${(s.percentage ?? 0).toFixed(2)}%</strong></div>
      `;
    }

    async function loadTodayHistory() {
      const container = document.getElementById("history-list");
      container.classList.remove("empty");
      container.textContent = "Loading…";

      const res = await api({
        action: "getAll",
        date: todayISO(),
      });

      if (!res.success) {
        container.classList.add("empty");
        container.textContent = res.error || "Failed to load.";
        return;
      }

      const rows = res.rows || [];
      if (!rows.length) {
        container.classList.add("empty");
        container.textContent = "No submissions yet for today.";
        return;
      }

      const html = [
        `<table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Approved by</th>
            </tr>
          </thead>
          <tbody>`
      ];

      for (const r of rows) {
        let pillClass = "pill--pending";
        let label = "Pending";
        const status = (r.status || "").toLowerCase();
        if (status === "approved-present") {
          pillClass = "pill--present";
          label = "Present";
        } else if (status === "approved-el") {
          pillClass = "pill--el";
          label = "EL";
        }

        html.push(`
          <tr>
            <td>${r.name || ""}</td>
            <td><span class="pill ${pillClass}">${label}</span></td>
            <td>${r.approvedBy || "-"}</td>
          </tr>
        `);
      }

      html.push("</tbody></table>");
      container.innerHTML = html.join("");
    }

    // ===== ADMIN FUNCTIONS =====
    function requireAdminPassword(msgEl) {
      const pwd = getAdminPassword();
      if (!pwd) {
        setMessage(msgEl, "Admin password required.", "error");
        return null;
      }
      return pwd;
    }

    async function openToday() {
      const msgEl = document.getElementById("admin-msg");
      const pwd = requireAdminPassword(msgEl);
      if (!pwd) return;

      setMessage(msgEl, "Opening today for submissions…");

      const res = await api({
        action: "toggleDay",
        adminPassword: pwd,
        date: todayISO(),
        open: true,
      });

      if (res.success) {
        setMessage(msgEl, "Today is now OPEN for submissions.", "success");
      } else {
        setMessage(msgEl, res.error || "Failed to open today.", "error");
      }
    }

    async function closeToday() {
      const msgEl = document.getElementById("admin-msg");
      const pwd = requireAdminPassword(msgEl);
      if (!pwd) return;

      setMessage(msgEl, "Closing today for submissions…");

      const res = await api({
        action: "toggleDay",
        adminPassword: pwd,
        date: todayISO(),
        open: false,
      });

      if (res.success) {
        setMessage(msgEl, "Today is now CLOSED for submissions.", "success");
      } else {
        setMessage(msgEl, res.error || "Failed to close today.", "error");
      }
    }

    async function registerMember() {
      const msgEl = document.getElementById("admin-msg");
      const pwd = requireAdminPassword(msgEl);
      if (!pwd) return;

      const nameInput = document.getElementById("register-name");
      const name = nameInput.value.trim();
      if (!name) {
        setMessage(msgEl, "Enter a name to register.", "error");
        return;
      }

      setMessage(msgEl, "Registering member…");

      const res = await api({
        action: "registerMember",
        adminPassword: pwd,
        name,
      });

      if (res.success) {
        setMessage(msgEl, res.info || "Member registered / activated.", "success");
        nameInput.value = "";
        loadMembers();
      } else {
        setMessage(msgEl, res.error || "Failed to register member.", "error");
      }
    }

    async function loadPending() {
      const container = document.getElementById("pending-list");
      container.classList.remove("empty");
      container.textContent = "Loading…";

      const res = await api({ action: "getPending" });

      if (!res.success) {
        container.classList.add("empty");
        container.textContent = res.error || "Failed to load pending list.";
        return;
      }

      const list = res.pending || [];
      if (!list.length) {
        container.classList.add("empty");
        container.textContent = "No pending submissions.";
        return;
      }

      const frag = document.createDocumentFragment();
      list.forEach(item => {
        const div = document.createElement("div");
        div.className = "pending-item";
        div.innerHTML = `
          <div>
            <div class="pending-name">${item.name || ""}</div>
            <div class="pending-date">${item.date || ""}</div>
          </div>
          <div class="history-small">Row #${item.row}</div>
          <div class="pending-actions">
            <button class="btn-sm" data-row="${item.row}" data-type="present">Present</button>
            <button class="btn-sm btn-ghost" data-row="${item.row}" data-type="EL">EL</button>
          </div>
        `;
        frag.appendChild(div);
      });

      container.innerHTML = "";
      container.appendChild(frag);

      container.querySelectorAll("button[data-row]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const row = Number(btn.getAttribute("data-row"));
          const type = btn.getAttribute("data-type");
          await approveRow(row, type);
        });
      });
    }

    async function approveRow(row, type) {
      const msgEl = document.getElementById("admin-msg");
      const pwd = requireAdminPassword(msgEl);
      if (!pwd) return;

      setMessage(msgEl, `Approving row ${row} as ${type}…`);

      const res = await api({
        action: "approveEntry",
        adminPassword: pwd,
        row,
        type,
        approvedBy: "Admin",
      });

      if (res.success) {
        setMessage(msgEl, `Row ${row} approved as ${type}.`, "success");
        loadPending();
        loadTodayHistory();
        loadPercentAll(); // optional refresh
      } else {
        setMessage(msgEl, res.error || "Failed to approve.", "error");
      }
    }

    async function loadMembers() {
      const container = document.getElementById("members-list");
      const msgEl = document.getElementById("admin-msg");
      const pwd = requireAdminPassword(msgEl);
      if (!pwd) return;

      container.classList.remove("empty");
      container.textContent = "Loading members…";

      const res = await api({
        action: "listMembers",
        adminPassword: pwd,
      });

      if (!res.success) {
        container.classList.add("empty");
        container.textContent = res.error || "Failed to load members.";
        return;
      }

      const members = res.members || [];
      if (!members.length) {
        container.classList.add("empty");
        container.textContent = "No members yet.";
        return;
      }

      const html = [
        `<table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>`
      ];

      members.forEach(m => {
        html.push(`
          <tr>
            <td>${m.name || ""}</td>
            <td>${m.status || "Active"}</td>
          </tr>
        `);
      });

      html.push("</tbody></table>");
      container.innerHTML = html.join("");
    }

    async function loadPercentAll() {
      const container = document.getElementById("percent-all");
      const msgEl = document.getElementById("admin-msg");
      const pwd = requireAdminPassword(msgEl);
      if (!pwd) return;

      container.classList.remove("empty");
      container.textContent = "Calculating…";

      const res = await api({
        action: "getPercentAll",
        adminPassword: pwd,
      });

      if (!res.success) {
        container.classList.add("empty");
        container.textContent = res.error || "Failed to load percentages.";
        return;
      }

      const stats = res.stats || [];
      if (!stats.length) {
        container.classList.add("empty");
        container.textContent = "No stats yet.";
        return;
      }

      const html = [
        `<table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>%</th>
              <th>Present</th>
              <th>EL</th>
              <th>Working</th>
            </tr>
          </thead>
          <tbody>`
      ];

      stats.forEach(s => {
        html.push(`
          <tr>
            <td>${s.name || ""}</td>
            <td>${(s.percentage ?? 0).toFixed(1)}%</td>
            <td>${s.present || 0}</td>
            <td>${s.el || 0}</td>
            <td>${s.totalWorkingDays || 0}</td>
          </tr>
        `);
      });

      html.push("</tbody></table>");
      container.innerHTML = html.join("");
    }

    // ===== INITIALIZE =====
    document.addEventListener("DOMContentLoaded", () => {
      // Today label
      document.getElementById("today-label").textContent = formatDateHuman(todayISO());

      // Student
      document.getElementById("btn-submit-att").addEventListener("click", submitAttendance);
      document.getElementById("btn-my-percent").addEventListener("click", loadMyPercentage);
      document.getElementById("btn-refresh-history").addEventListener("click", loadTodayHistory);

      // Admin
      document.getElementById("btn-open-today").addEventListener("click", openToday);
      document.getElementById("btn-close-today").addEventListener("click", closeToday);
      document.getElementById("btn-register").addEventListener("click", registerMember);
      document.getElementById("btn-refresh-pending").addEventListener("click", loadPending);
      document.getElementById("btn-refresh-members").addEventListener("click", loadMembers);
      document.getElementById("btn-refresh-percent-all").addEventListener("click", loadPercentAll);
      document.getElementById("btn-clear-admin").addEventListener("click", () => {
        document.getElementById("admin-password").value = "";
        setMessage(document.getElementById("admin-msg"), "");
      });

      // Initial data
      loadTodayHistory();
      loadPending();
    });
  </script>
</body>
</html>

